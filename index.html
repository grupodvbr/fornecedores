<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Responder Cota√ß√£o</title>
<style>
  body{font-family:Inter,Arial,sans-serif;background:#f9fafb;margin:0;padding:20px}
  .box{max-width:920px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  h1{margin:0 0 6px;text-align:center}
  p#info{margin:4px 0 12px;color:#6b7280;text-align:center}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin:8px 0 16px}
  .toolbar select,.toolbar input{padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:15px}
  .toolbar .hint{font-size:12px;color:#6b7280}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e7eb;padding:8px}
  th{background:#2563eb;color:#fff}
  input,button{padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:15px}
  input[type=text].money{width:120px;text-align:right}
  input[type=text]{width:100%}
  button[type=submit]{width:100%;margin-top:16px;background:#2563eb;color:#fff;cursor:pointer}
  button[type=submit]:hover{background:#1d4ed8}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:999}
  .overlay .card{background:#fff;padding:18px 22px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.25);font-weight:600}
  .notice{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:10px;border-radius:8px;margin:10px 0}
  .success{background:#ecfdf5;border:1px solid #6ee7b7;color:#065f46;padding:10px;border-radius:8px;margin:10px 0}
  .muted{color:#6b7280;font-size:13px}
  .actions{display:flex;gap:10px;justify-content:center;margin-top:10px}
  .btn-secondary{background:#e5e7eb;color:#111827;border:1px solid #d1d5db}
</style>
</head>
<body>
  <div class="box">
    <h1 id="titulo">Responder Cota√ß√£o</h1>
    <p id="info">Carregando cota√ß√µes pendentes‚Ä¶</p>

    <!-- Toolbar com fornecedor + senha -->
    <div class="toolbar">
      <label>Fornecedor:
        <select id="selFornecedor"></select>
      </label>
      <label>Senha:
        <input id="inputSenha" type="password" inputmode="numeric" pattern="\\d*" placeholder="Digite a senha">
      </label>
      <span class="hint">Informe o fornecedor e a senha para enviar.</span>
    </div>

    <div id="statusEnvio" class="success" style="display:none"></div>
    <div id="avisoExpirado" class="notice" style="display:none"></div>

    <form id="formRespostas">
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Qtd</th>
            <th>Unid</th>
            <th>Pre√ßo Unit.</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <button id="btnEnviar" type="submit">üì§ Enviar Respostas</button>
      <div class="actions">
        <button id="btnSolicitarLiberacao" type="button" class="btn-secondary" style="display:none">Solicitar libera√ß√£o</button>
      </div>
      <p id="timer" class="muted" style="text-align:center;margin-top:8px;display:none"></p>
    </form>
  </div>

  <div class="overlay" id="overlay"><div class="card">‚è≥ Salvando na planilha‚Ä¶</div></div>

<script>
/* ===================== CONFIG ===================== */
// URL do seu GAS
const URL_COTACAO = "https://script.google.com/macros/s/AKfycbzRQ0GAmz9m_2F-Ms4DzLQWUqQvmlpBxeMpVOPoXvvuRx-VkjqZbSIVGSWTo2-okjvD/exec";

// Lista de fornecedores exibidos no menu
const FORNECEDORES = ["Fornecedor A", "Fornecedor B", "Fornecedor C"];

// Senha por fornecedor (simples, lado do cliente ‚Äî apenas para bloquear reenvio acidental)
const SENHAS = {
  "Fornecedor A": "1111",
  "Fornecedor B": "2222",
  "Fornecedor C": "3333"
};

// Tempo de validade: 1 hora (ms)
const VALIDADE_MS = 60 * 60 * 1000;

/* ============== Vari√°veis de estado =============== */
let fornecedor = "", empresa = "", painel = "";
let itens = [];
let keyBase = "";           // chave base para localStorage
let abriuEm = null;         // timestamp de abertura
let timerId = null;

/* ===================== Utils ====================== */
function normalizeMoneyInputString(v){
  if(!v) return "";
  return String(v).replace(/\s/g,'').replace(',','.');
}
function showOverlay(on){ document.getElementById('overlay').style.display = on ? 'flex' : 'none'; }
function disableForm(on){
  document.querySelectorAll('#formRespostas input, #formRespostas button[type=submit]').forEach(el=>el.disabled = on);
}
function lsGet(k, def=null){ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; }catch{ return def; } }
function lsSet(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
function fmtData(dt){ try{ return new Date(dt).toLocaleString('pt-BR'); }catch{ return String(dt); } }

/* ============== Expira√ß√£o & Hist√≥rico ============== */
function setOpenTimeIfMissing(){
  const k = keyBase + ":openTs";
  let ts = lsGet(k, null);
  if(!ts){
    ts = Date.now();
    lsSet(k, ts);
  }
  abriuEm = ts;
}
function isExpired(){
  if(!abriuEm) return false;
  return (Date.now() - abriuEm) > VALIDADE_MS;
}
function renderCountdown(){
  const el = document.getElementById('timer');
  if(!abriuEm){ el.style.display='none'; return; }
  const left = VALIDADE_MS - (Date.now() - abriuEm);
  if(left <= 0){ el.textContent = "‚õî Cota√ß√£o expirada."; return; }
  const m = Math.floor(left/60000), s = Math.floor((left%60000)/1000);
  el.textContent = `‚è±Ô∏è Tempo restante: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  el.style.display = 'block';
}
function startCountdown(){
  if(timerId) clearInterval(timerId);
  renderCountdown();
  timerId = setInterval(()=>{
    renderCountdown();
    if(isExpired()){
      onExpiredUI();
      clearInterval(timerId);
    }
  }, 1000);
}
function onExpiredUI(){
  const box = document.getElementById('avisoExpirado');
  box.style.display = 'block';
  box.innerHTML = "‚õî O link de cota√ß√£o <b>expirou</b>. Pe√ßa a libera√ß√£o no painel de cota√ß√µes.";
  disableForm(true);
  document.getElementById('btnSolicitarLiberacao').style.display = 'inline-block';
}
function blockIfAlreadySent(){
  const sent = lsGet(keyBase + ":sent", null);
  if(sent && sent.fornecedor === fornecedor){
    const info = document.getElementById('statusEnvio');
    info.style.display = 'block';
    info.innerHTML = `‚úÖ Respostas j√° enviadas por <b>${sent.fornecedor}</b> em <b>${fmtData(sent.ts)}</b>. Envio duplicado n√£o permitido.`;
    disableForm(true);
    return true;
  }
  return false;
}
function pushHistory(enviados){
  const k = keyBase + ":history";
  const arr = lsGet(k, []);
  arr.push({ ts: Date.now(), enviados, fornecedor });
  lsSet(k, arr);
}

/* =================== Carregamento =================== */
window.addEventListener('load', async ()=>{
  const p = new URLSearchParams(location.search);
  const fornecedorUrl = p.get("fornecedor") || "";
  empresa = p.get("empresa") || "";
  painel  = p.get("painel")  || ""; // reservado para uso futuro

  // Chave base por empresa + fornecedor (poderia incluir painel se quiser)
  fornecedor = fornecedorUrl || FORNECEDORES[0];
  keyBase = `cotacao:${empresa}:${fornecedor}`;

  // Popula dropdown de fornecedores
  const sel = document.getElementById('selFornecedor');
  sel.innerHTML = FORNECEDORES.map(f=>`<option value="${f}">${f}</option>`).join('');
  if(fornecedorUrl && FORNECEDORES.includes(fornecedorUrl)) sel.value = fornecedorUrl;
  else sel.value = FORNECEDORES[0];

  sel.addEventListener('change', ()=>{
    fornecedor = sel.value;
    keyBase = `cotacao:${empresa}:${fornecedor}`;
    document.getElementById('titulo').textContent = `Responder Cota√ß√£o ‚Äì ${fornecedor}`;
    // Revalida bloqueios com o novo fornecedor
    document.getElementById('statusEnvio').style.display = 'none';
    disableForm(false);
    blockIfAlreadySent();
  });

  document.getElementById('titulo').textContent = `Responder Cota√ß√£o ‚Äì ${fornecedor}`;

  // Define/recupera hora de abertura
  setOpenTimeIfMissing();
  startCountdown();

  // Se j√° enviou, bloqueia
  if(blockIfAlreadySent()) return;

  // Se j√° expirou, bloqueia interface
  if(isExpired()){
    onExpiredUI();
    return;
  }

  // Carrega itens
  await carregarItens();
});

async function carregarItens(){
  try{
    const res = await fetch(`${URL_COTACAO}?action=listar_fornecedores&empresa=${encodeURIComponent(empresa)}`);
    const out = await res.json();
    if(!out.ok || !out.items || out.items.length===0){
      document.getElementById('info').textContent = "‚úÖ Nenhuma cota√ß√£o pendente.";
      return;
    }
    itens = out.items;
    render();
    document.getElementById('info').textContent = `Exibindo ${itens.length} cota√ß√µes pendentes`;
  }catch(e){
    alert("Erro ao carregar itens: " + e.message);
  }
}

function render(){
  const tb = document.getElementById('tbody');
  tb.innerHTML = "";
  itens.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.produto}</td>
      <td>${it.quantidade ?? ''}</td>
      <td>${it.unidade ?? ''}</td>
      <td>
        <input type="text" class="money" inputmode="decimal" placeholder="0,00"
               data-rid="${it.rid}" data-codigo="${it.codigo || ''}" data-produto="${it.produto}">
      </td>
      <td><input type="text" class="obs" placeholder="Observa√ß√£o"></td>
    `;
    tb.appendChild(tr);
  });

  // m√°scara b√°sica: somente d√≠gitos, v√≠rgula e ponto (1 separador)
  document.querySelectorAll('input.money').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      let v = inp.value.replace(/[^\d.,]/g,'');
      const parts = v.split(/[.,]/);
      if(parts.length>1){
        v = parts.shift() + ',' + parts.join('');
      }
      inp.value = v;
    });
  });
}

/* =================== Envio & senha =================== */
document.getElementById('formRespostas').addEventListener('submit', async (e)=>{
  e.preventDefault();

  // janela ainda v√°lida?
  if(isExpired()){
    onExpiredUI();
    return;
  }
  // senha confere?
  const senhaInformada = (document.getElementById('inputSenha').value || '').trim();
  const senhaEsperada  = SENHAS[fornecedor] || "";
  if(!senhaInformada || senhaInformada !== senhaEsperada){
    alert("Senha inv√°lida para o fornecedor selecionado.");
    return;
  }
  // j√° foi enviado?
  if(blockIfAlreadySent()) return;

  const linhas = document.querySelectorAll('#tbody tr');
  if(!linhas.length){ alert('Nada para enviar.'); return; }

  showOverlay(true);
  let enviados = 0, erros = [];

  for(const ln of linhas){
    const inputPreco = ln.querySelector('input.money');
    const precoStr   = normalizeMoneyInputString(inputPreco.value);
    const obs        = ln.querySelector('input.obs').value || "";

    if(precoStr === "") continue; // s√≥ envia linhas preenchidas

    const payload = {
      action: "responder_fornecedor",
      rid: inputPreco.dataset.rid,
      produtoCodigo: inputPreco.dataset.codigo,
      produtoNome: inputPreco.dataset.produto,
      fornecedor,
      preco: precoStr,
      observacoes: obs,
      empresa
    };

    try{
      const res = await fetch(URL_COTACAO, {
        method: "POST",
        headers: {"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify(payload)
      });
      const out = await res.json();
      if(out.ok){ enviados += (out.count || 1); }
      else{ erros.push(out.error || 'Falha desconhecida'); }
    }catch(err){
      erros.push(String(err));
    }
  }

  showOverlay(false);

  if(erros.length){
    alert(`‚ö†Ô∏è Enviadas: ${enviados}\nErros: ${erros.length}\n\nPrimeiro erro: ${erros[0]}`);
    return;
  }

  // marca como enviado e guarda hist√≥rico
  lsSet(keyBase + ":sent", { ts: Date.now(), fornecedor });
  pushHistory(enviados);

  const info = document.getElementById('statusEnvio');
  info.style.display = 'block';
  info.innerHTML = `‚úÖ ${enviados} respostas registradas por <b>${fornecedor}</b> em <b>${fmtData(Date.now())}</b>.`;
  disableForm(true);
});

/* ======= Bot√£o ‚ÄúSolicitar libera√ß√£o‚Äù (visual por ora) ======= */
document.getElementById('btnSolicitarLiberacao').addEventListener('click', ()=>{
  alert("Solicita√ß√£o de libera√ß√£o registrada localmente. A libera√ß√£o dever√° ser feita no painel de cota√ß√µes.");
  // Aqui futuramente podemos chamar o GAS: action=solicitar_liberacao com empresa/fornecedor/painel.
});
</script>
</body>
</html>
