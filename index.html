<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Responder Cota√ß√£o</title>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --soft:#0d1931; --txt:#e5e7eb; --muted:#94a3b8;
      --brand:#3b82f6; --brand-2:#2563eb; --ok:#10b981; --okbg:#05291e; --warn:#f59e0b; --warnbg:#332406;
      --bd:#1e293b; --chip:#1f2a44;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:var(--txt);padding:10px}
    .shell{max-width:980px;margin:auto}

    .hero{border:1px solid rgba(148,163,184,.12);border-radius:14px;padding:10px;background:#0d1629;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    h1{margin:0;text-align:center;font-weight:800;letter-spacing:.2px;font-size:1.12rem}
    .subtitle{margin:4px 0 0;color:var(--muted);text-align:center;font-size:.88rem}

    .toolbar{margin:8px 0 6px;display:grid;grid-template-columns:1fr 1fr auto;gap:6px}
    @media (max-width:640px){.toolbar{grid-template-columns:1fr 1fr auto}}
    .field{display:flex;gap:4px;align-items:center}
    .field label{font-size:.8rem;color:#cbd5e1}
    .field select,.field input{height:40px;border:1px solid var(--bd);background:var(--soft);color:var(--txt);border-radius:10px;padding:8px 10px;font-size:14px;width:100%}
    .btn{height:40px;border-radius:10px;border:1px solid rgba(59,130,246,.45);background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;padding:0 12px;font-weight:700;cursor:pointer;white-space:nowrap}
    .btn.small{height:34px;padding:0 10px;border-radius:9px}

    .minibar{display:none;align-items:center;justify-content:center;gap:8px;background:#0b1220;border:1px solid rgba(148,163,184,.12);border-radius:10px;padding:6px 8px;margin:6px 0 8px;color:#cbd5e1;font-size:.88rem}

    .notice,.success{border-radius:12px;padding:10px 12px;margin:8px 0;font-size:.95rem}
    .notice{background:var(--warnbg);color:#ffcc66;border:1px solid rgba(245,158,11,.35)}
    .success{background:var(--okbg);color:#34d399;border:1px solid rgba(16,185,129,.35)}

    .tabs{display:flex;gap:6px;margin:8px 0}
    .tab{border:1px solid rgba(148,163,184,.2);background:#0b1220;color:#cbd5e1;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .tab.active{border-color:rgba(59,130,246,.45);background:linear-gradient(180deg,#0f1a34,#0b1220)}

    .table-wrap{display:none;width:100%;overflow:auto;border:1px solid var(--bd);border-radius:12px;background:var(--soft)}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th,td{border-bottom:1px solid var(--bd);padding:10px}
    th{position:sticky;top:0;background:#0d1629}
    .money{width:150px;text-align:right}

    .cards{display:none;gap:10px;margin-top:6px}
    .card{background:linear-gradient(180deg,#0e182f,#0b1220);border:1px solid rgba(148,163,184,.12);border-radius:14px;padding:10px;box-shadow:0 8px 20px rgba(0,0,0,.35)}
    .prod{font-weight:800;letter-spacing:.2px}
    .chips{display:flex;gap:6px;margin:6px 0 8px;flex-wrap:wrap}
    .chip{background:var(--chip);color:#cbd5e1;padding:5px 9px;border-radius:999px;font-size:.8rem}
    .grid{display:grid;grid-template-columns:1fr;gap:8px}
    .grid .field input{height:42px}
    @media (min-width:640px){.cards{grid-template-columns:1fr 1fr}}

    .inline-tip{color:var(--muted);font-size:.85rem;text-align:center;margin-top:6px;display:none}

    .fabbar{position:fixed;left:0;right:0;bottom:0;padding:8px 10px;background:linear-gradient(180deg,transparent,rgba(2,6,23,.92) 18%,rgba(2,6,23,.98));backdrop-filter:blur(6px);border-top:1px solid rgba(148,163,184,.1);display:none;z-index:50}
    .fabinner{max-width:980px;margin:auto;display:flex;gap:8px;align-items:center}
    .time{color:#cbd5e1;font-size:.9rem;white-space:nowrap}
    .btn-send{flex:1;height:46px;border:none;border-radius:12px;font-weight:800;color:#fff;background:linear-gradient(180deg,var(--brand),var(--brand-2));box-shadow:0 10px 24px rgba(37,99,235,.35);cursor:pointer}
    .btn-gray{background:#1f2937;border:1px solid #334155;color:#e5e7eb}

    .pagefooter{display:none;margin:14px auto 0;padding:12px;border:1px solid rgba(148,163,184,.12);border-radius:12px;background:#0d1629}
    .footer-inner{max-width:980px;margin:auto;display:flex;gap:10px;align-items:center;justify-content:flex-end}
    .footer-inner .time{margin-right:auto}
    .footer-btn{height:42px;border:none;border-radius:10px;padding:0 14px;font-weight:800;color:#fff;cursor:pointer}
    .footer-send{background:linear-gradient(180deg,var(--brand),var(--brand-2))}
    .footer-gray{background:#1f2937;border:1px solid #334155}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:999}
    .overlay .card{background:#0b1220;padding:16px 18px;border-radius:12px;border:1px solid rgba(148,163,184,.18);font-weight:700}

    .histWrap{display:none;border:1px solid var(--bd);border-radius:12px;background:#0b1220;padding:10px}
    .histHead{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .muted{color:#94a3b8}
    .histTable{width:100%;border-collapse:collapse}
    .histTable th,.histTable td{border-bottom:1px solid var(--bd);padding:8px 10px;font-size:.95rem}
    .histTable th{background:#0d1629;text-align:left}

    @media (max-width:639px){.cards{display:grid}.fabbar{display:block}}
    @media (min-width:640px){.table-wrap{display:block}.pagefooter{display:block}}
  </style>
</head>
<body>
<div class="shell hero">
  <h1 id="titulo">Responder Cota√ß√£o</h1>
  <p id="info" class="subtitle">Fa√ßa login para visualizar os itens.</p>

  <!-- LOGIN -->
  <div class="toolbar" id="toolbar">
    <div class="field">
      <label>Fornecedor</label>
      <select id="selFornecedor"></select>
    </div>
    <div class="field">
      <label>Senha</label>
      <input id="inputSenha" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="Senha">
    </div>
    <button id="btnValidar" class="btn" type="button">Validar</button>
  </div>

  <div id="miniBar" class="minibar">‚úÖ Logado</div>

  <div class="tabs">
    <button class="tab active" data-tab="cotacao">Itens</button>
    <button class="tab" data-tab="historico">Hist√≥rico</button>
  </div>

  <div id="statusEnvio" class="success" style="display:none"></div>
  <div id="avisoExpirado" class="notice" style="display:none"></div>

  <!-- TAB: COTA√á√ÉO -->
  <div id="tabCotacao">
    <div class="table-wrap" id="tableWrap">
      <table>
        <thead>
          <tr><th>Produto</th><th>Qtd</th><th>Unid</th><th>Pre√ßo Unit.</th><th>Obs</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="cards" id="cards"></div>

    <p id="dicaMascara" class="inline-tip">Dica: digite apenas n√∫meros. Ex.: ‚Äú1234‚Äù vira ‚Äú12,34‚Äù.</p>

    <div class="pagefooter" id="footerDesk">
      <div class="footer-inner">
        <div class="time" id="timerDesk">‚è±Ô∏è 60:00</div>
        <button id="btnSolicitarLiberacaoDesk" class="footer-btn footer-gray" style="display:none">Solicitar libera√ß√£o</button>
        <button id="btnEnviarDesk" class="footer-btn footer-send">üì§ Enviar Respostas</button>
      </div>
    </div>
  </div>

  <!-- TAB: HIST√ìRICO -->
  <div id="tabHistorico" class="histWrap">
    <div class="histHead">
      <label style="display:flex;align-items:center;gap:6px">
        <input id="histOnlyCurrent" type="checkbox" checked>
        <span>Somente desta empresa/fornecedor</span>
      </label>
      <button id="btnHistRefresh" class="btn small">Atualizar</button>
      <button id="btnHistClear" class="btn small" style="background:#334155;border-color:#475569">Limpar hist√≥rico (contexto)</button>
      <span class="muted" id="histCount" style="margin-left:auto"></span>
    </div>
    <div id="histEmpty" class="muted" style="display:none">Sem hist√≥rico local.</div>
    <div style="overflow:auto">
      <table class="histTable" id="histTable">
        <thead><tr><th>Data</th><th>Fornecedor</th><th>Empresa</th><th>Painel</th><th>Enviados</th></tr></thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="fabbar" id="fab">
  <div class="fabinner">
    <div class="time" id="timer">‚è±Ô∏è 60:00</div>
    <button id="btnSolicitarLiberacao" class="btn-send btn-gray" style="display:none">Solicitar libera√ß√£o</button>
    <button id="btnEnviar" class="btn-send">üì§ Enviar Respostas</button>
  </div>
</div>

<div class="overlay" id="overlay"><div class="card">‚è≥ Salvando na planilha‚Ä¶</div></div>

<script>
/* ===== CONFIG ===== */
const URL_COTACAO = "https://script.google.com/macros/s/AKfycbzjA0wxQDANQERLWRy3gXhWoL30nnVBWO8v5x7L-ktFkgtQYl9m4WncYRPFUqR3hkjw/exec";
const VALIDADE_MS = 60*60*1000;

/* ===== Estado ===== */
let fornecedor="", empresa="", painel="";
let itens=[]; let keyBase=""; let abriuEm=null; let timerId=null;

/* ===== Utils ===== */
const $ = (id)=>document.getElementById(id);
const qsAll = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const lsGet=(k,d=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{ return d }};
const lsSet=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const lsDel=(k)=>localStorage.removeItem(k);
const showOverlay=(on)=>{$('overlay').style.display=on?'flex':'none'};
const fmtData=(dt)=>{try{return new Date(dt).toLocaleString('pt-BR')}catch{return String(dt)}};
const isMobile=()=>matchMedia('(max-width:639px)').matches;

/* ===== Money ===== */
function centsToBR(c){const neg=c<0; c=Math.abs(c); const s=String(c).padStart(3,'0'); const i=s.slice(0,-2)||'0', d=s.slice(-2); return (neg?'-':'')+i.replace(/\B(?=(\d{3})+(?!\d))/g,'.')+','+d;}
function centsToDotDecimal(c){ return ((parseInt(c,10)||0)/100).toFixed(2); }
function bindMoneyInputs(scope=document){
  scope.querySelectorAll('input.money').forEach(inp=>{
    inp.type='text'; inp.inputMode='decimal'; inp.autocomplete='off'; inp.spellcheck=false;
    if(!inp.dataset.cents) inp.dataset.cents='0';
    inp.value=centsToBR(parseInt(inp.dataset.cents,10)||0);
    inp.addEventListener('input',()=>{
      const digits=(inp.value.replace(/\D/g,'')||'0').replace(/^0+(?=\d)/,'');
      const cents=parseInt(digits,10)||0; inp.dataset.cents=String(cents);
      inp.value=centsToBR(cents);
    });
    inp.addEventListener('focus',()=>setTimeout(()=>inp.select(),0));
  });
}
function readCentsFromInput(inp){
  let c = inp?.dataset?.cents;
  if (c == null || c === '' || isNaN(parseInt(c,10))){
    const digits=(inp.value||'').toString().replace(/\D/g,'') || '0';
    c = String(parseInt(digits,10)||0);
    inp.dataset.cents = c;
  }
  return parseInt(c,10)||0;
}

/* ===== Sess√£o / janela ===== */
function setOpenTimeIfMissing(){const k=keyBase+":openTs"; let ts=lsGet(k,null); if(!ts){ts=Date.now();lsSet(k,ts)} abriuEm=ts;}
function isExpiredLocal(){return abriuEm ? (Date.now()-abriuEm)>VALIDADE_MS:false}
function isLogged(){return !!lsGet(keyBase+":logged",null) && !isExpiredLocal()}
function renderCountdown(){
  const left=VALIDADE_MS-(Date.now()-abriuEm);
  const m=Math.max(0,Math.floor(left/60000)), s=Math.max(0,Math.floor((left%60000)/1000));
  const txt = left<=0 ? '‚õî Expirado' : `‚è±Ô∏è ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  const t1=$('timer'); if(t1) t1.textContent=txt; const t2=$('timerDesk'); if(t2) t2.textContent=txt;
}
function startCountdown(){
  if(timerId) clearInterval(timerId); renderCountdown();
  timerId=setInterval(()=>{renderCountdown(); if(isExpiredLocal()){onExpiredUI(); clearInterval(timerId)}},1000);
}

/* ===== Servidor / libera√ß√£o ===== */
async function checkServerLiberation(){
  try{
    const u=`${URL_COTACAO}?action=checar_liberacao&empresa=${encodeURIComponent(empresa)}&fornecedor=${encodeURIComponent(fornecedor)}&painel=${encodeURIComponent(painel)}`;
    const j=await (await fetch(u)).json(); return !!(j&&j.ok&&j.liberado);
  }catch{return false}
}

/* ===== Duplicado / hist√≥rico ===== */
function blockIfAlreadySent(){
  const sent=lsGet(keyBase+":sent",null);
  if(sent && sent.fornecedor===fornecedor){
    const box=$('statusEnvio');
    box.style.display='block';
    box.innerHTML=`‚úÖ Respostas j√° enviadas por <b>${sent.fornecedor}</b> em <b>${fmtData(sent.ts)}</b>.`;
    disableSendButtons(true);
    return true;
  }
  return false;
}
function pushHistory(c){
  const k=keyBase+":history";
  const a=lsGet(k,[]);
  a.push({ts:Date.now(),enviados:c,fornecedor,empresa,painel});
  lsSet(k,a);
}
function disableSendButtons(on){
  qsAll('.btn-enviar, #btnEnviar, #btnEnviarDesk').forEach(b=>b.disabled=on);
}

/* ===== Render ===== */
function renderCards(){
  const wrap=$('cards'); wrap.innerHTML=''; wrap.style.display='grid';
  itens.forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="prod">${it.produto}</div>
      <div class="chips">
        <div class="chip">Qtd: <b>${it.quantidade??''}</b></div>
        <div class="chip">Unid: <b>${it.unidade??''}</b></div>
      </div>
      <div class="grid">
        <div class="field">
          <input class="money" placeholder="0,00" data-rid="${it.rid}" data-codigo="${it.codigo||''}" data-produto="${it.produto}">
        </div>
        <div class="field">
          <input type="text" class="obs" placeholder="Observa√ß√£o">
        </div>
      </div>`;
    wrap.appendChild(card);
  });
  bindMoneyInputs(wrap);
}
function renderTable(){
  const tb=$('tbody'); tb.innerHTML=''; $('tableWrap').style.display='block';
  itens.forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.produto}</td>
      <td>${it.quantidade??''}</td>
      <td>${it.unidade??''}</td>
      <td><input class="money" placeholder="0,00" data-rid="${it.rid}" data-codigo="${it.codigo||''}" data-produto="${it.produto}"></td>
      <td><input type="text" class="obs" placeholder="Observa√ß√£o"></td>`;
    tb.appendChild(tr);
  });
  bindMoneyInputs(tb);
}
function renderList(){
  $('tableWrap').style.display='none'; $('cards').style.display='none';
  if(isMobile()) renderCards(); else renderTable();
}

/* ===== Fluxo de login ===== */
function shrinkNav(){
  $('toolbar').style.display='none';
  $('miniBar').style.display='flex';
  $('miniBar').textContent=`‚úÖ ${fornecedor} ‚Ä¢ ${empresa||'‚Äî'}`;
}
async function enterLoggedState(){
  setOpenTimeIfMissing(); startCountdown(); shrinkNav();
  $('dicaMascara').style.display='block';
  $('fab').style.display = isMobile() ? 'block' : 'none';
  $('footerDesk').style.display = isMobile() ? 'none' : 'block';
  await carregarItens(); renderList(); blockIfAlreadySent();
  $('info').textContent=`Itens liberados durante a janela.`;
}
function onExpiredUI(){
  $('avisoExpirado').style.display='block';
  $('avisoExpirado').innerHTML="‚õî Janela expirada. Envie somente com libera√ß√£o do painel.";
  $('btnSolicitarLiberacao').style.display='';
  $('btnSolicitarLiberacaoDesk').style.display='';
}

/* ===== Boot ===== */
window.addEventListener('load', async ()=>{
  const p=new URLSearchParams(location.search);
  empresa=p.get('empresa')||''; painel=p.get('painel')||''; const fornURL=p.get('fornecedor')||'';
  fornecedor=fornURL||''; keyBase=`cotacao:${empresa}:${fornecedor}:${painel}`;
  await carregarFornecedores(fornURL);
  $('titulo').textContent=`Responder Cota√ß√£o ‚Äî ${fornecedor||'(selecione)'}`;
  const ts=lsGet(keyBase+":openTs",null); if(ts) abriuEm=ts;
  if(isLogged()) await enterLoggedState();

  qsAll('.tab').forEach(btn=>btn.addEventListener('click',()=>switchTab(btn.dataset.tab)));
  $('btnHistRefresh').addEventListener('click',renderHistory);
  $('histOnlyCurrent').addEventListener('change',renderHistory);
  $('btnHistClear').addEventListener('click',()=>{ if(confirm('Limpar hist√≥rico local deste contexto?')){ lsDel(keyBase+":history"); renderHistory(); }});
  window.addEventListener('resize',()=>{ renderList(); $('fab').style.display = isMobile() ? 'block' : 'none'; $('footerDesk').style.display = isMobile() ? 'none' : 'block'; });
  renderHistory();
});

/* ===== Tabs ===== */
function switchTab(name){
  qsAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  $('tabCotacao').style.display = (name==='cotacao') ? 'block' : 'none';
  $('tabHistorico').style.display = (name==='historico') ? 'block' : 'none';
}

/* ===== Dados ===== */
async function carregarFornecedores(pref){
  try{
    const j=await (await fetch(`${URL_COTACAO}?action=fornecedores_lista`)).json();
    const sel=$('selFornecedor'); sel.innerHTML='';
    const items=(j&&j.ok&&Array.isArray(j.items))?j.items:[];
    if(!items.length){ sel.innerHTML='<option>(sem fornecedores)</option>'; fornecedor=''; return; }
    items.sort((a,b)=>a.fornecedor.localeCompare(b.fornecedor,'pt-BR'));
    for(const x of items){ const o=document.createElement('option'); o.value=x.fornecedor; o.textContent=x.fornecedor; sel.appendChild(o); }
    if(pref && items.some(x=>x.fornecedor===pref)){ sel.value=pref; fornecedor=pref } else { fornecedor=sel.value }
    keyBase=`cotacao:${empresa}:${fornecedor}:${painel}`;
    sel.addEventListener('change',()=>{
      fornecedor=sel.value; keyBase=`cotacao:${empresa}:${fornecedor}:${painel}`;
      $('titulo').textContent=`Responder Cota√ß√£o ‚Äî ${fornecedor}`; $('miniBar').style.display='none';
      $('info').textContent='Fa√ßa login para visualizar os itens.'; $('cards').innerHTML=''; $('tbody').innerHTML='';
      $('dicaMascara').style.display='none'; $('fab').style.display='none'; $('footerDesk').style.display='none'; $('toolbar').style.display='grid';
      renderHistory();
    });
  }catch(e){ alert('Erro ao carregar fornecedores: '+e.message); }
}
async function carregarItens(){
  const j=await (await fetch(`${URL_COTACAO}?action=listar_fornecedores&empresa=${encodeURIComponent(empresa)}`)).json();
  if(!j.ok || !Array.isArray(j.items) || !j.items.length){
    $('info').textContent='‚úÖ Nenhuma cota√ß√£o pendente.'; itens=[];
  } else {
    itens=j.items;
    if(!empresa && itens[0]?.empresa){
      const oldKey = keyBase;
      empresa = itens[0].empresa;
      keyBase = `cotacao:${empresa}:${fornecedor}:${painel}`;
      const logged = lsGet(oldKey+":logged",null);
      const ts     = lsGet(oldKey+":openTs",null);
      if(logged) lsSet(keyBase+":logged",logged);
      if(ts)     lsSet(keyBase+":openTs",ts);
      if(logged) $('miniBar').textContent=`‚úÖ ${fornecedor} ‚Ä¢ ${empresa}`;
    }
    $('info').textContent=`Exibindo ${itens.length} itens para cota√ß√£o`;
  }
}

/* ===== Validar login ===== */
async function validarFornecedor(){
  const senha=($('inputSenha').value||'').trim();
  if(!fornecedor){ alert('Selecione o fornecedor.'); return false }
  if(!senha){ alert('Informe a senha.'); return false }
  try{
    const out=await (await fetch(URL_COTACAO,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},
      body:JSON.stringify({action:'validar_fornecedor',fornecedor,senha})})).json();
    if(out&&out.ok){ lsSet(keyBase+":logged",{ts:Date.now(),fornecedor}); await enterLoggedState(); return true }
    alert('Senha inv√°lida.'); return false;
  }catch(e){ alert('Falha ao validar: '+e.message); return false }
}
$('btnValidar').addEventListener('click',()=>validarFornecedor());
$('inputSenha').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); validarFornecedor(); }});

/* ===== Libera√ß√£o ===== */
function wireSolicitarLiberacaoButtons(){
  const handler = async ()=>{
    if(!fornecedor){ alert('Selecione o fornecedor.'); return; }
    try{
      const out=await (await fetch(URL_COTACAO,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},
        body:JSON.stringify({action:'solicitar_liberacao',empresa,fornecedor,painel})})).json();
      alert(out&&out.ok?'üì® Solicita√ß√£o enviada. Aguarde aprova√ß√£o.':'N√£o foi poss√≠vel solicitar.');
    }catch(e){ alert('Erro: '+e.message); }
  };
  ['btnSolicitarLiberacao','btnSolicitarLiberacaoDesk'].forEach(id=>{
    const el=$(id); if(el){ el.addEventListener('click',handler); }
  });
}
wireSolicitarLiberacaoButtons();

/* ===== Envio ===== */
function wireEnviarButtons(){
  const handler = async ()=>{
    if(blockIfAlreadySent()) return;

    const roots = isMobile() ? document.querySelectorAll('#cards .card')
                             : document.querySelectorAll('#tbody tr');
    if(!roots.length){ alert('Nada para enviar.'); return; }

    // monta itens
    const itensPayload = [];
    roots.forEach(root=>{
      const priceEl = root.querySelector('input.money');
      const cents   = readCentsFromInput(priceEl);
      if(cents <= 0) return;
      itensPayload.push({
        rid:     priceEl.dataset.rid,
        codigo:  priceEl.dataset.codigo,
        produto: priceEl.dataset.produto,
        preco:   centsToDotDecimal(cents), // "12.34"
        obs:     (root.querySelector('.obs')?.value)||''
      });
    });
    if(itensPayload.length === 0){ alert('Informe pelo menos um pre√ßo para enviar.'); return; }

    if(!empresa){ empresa = itens.find(x=>x.empresa)?.empresa || ''; }

    // Janela/Libera√ß√£o
    const expired = isExpiredLocal();
    if(expired){
      const liberado = await checkServerLiberation();
      if(!liberado){
        alert('‚õî Janela expirada. Solicite libera√ß√£o no painel para enviar.');
        $('btnSolicitarLiberacao').style.display='';
        $('btnSolicitarLiberacaoDesk').style.display='';
        return;
      }
    }

    if(!confirm(`Voc√™ deseja enviar ${itensPayload.length} resposta(s) para a planilha?`)) return;

    showOverlay(true);
    try{
      const out = await (await fetch(URL_COTACAO,{
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({
          action:'responder_json',
          fornecedor,
          empresa,
          painelCodigo:painel,
          itens: itensPayload,
          expired // o servidor exige libera√ß√£o quando true
        })
      })).json();

      showOverlay(false);

      if(!out?.ok){
        alert('Falha no envio: ' + (out?.error || 'erro desconhecido'));
        return;
      }

      lsSet(keyBase+":sent",{ts:Date.now(),fornecedor});
      pushHistory(out.count || itensPayload.length);
      $('statusEnvio').style.display='block';
      $('statusEnvio').innerHTML =
        `‚úÖ ${out.count || itensPayload.length} respostas registradas por <b>${fornecedor}</b> em <b>${fmtData(Date.now())}</b>.`;
      disableSendButtons(true);
      renderHistory();
    }catch(e){
      showOverlay(false);
      alert('Erro ao enviar: ' + e.message);
    }
  };

  ['btnEnviar','btnEnviarDesk'].forEach(id=>{
    const el=$(id); if(el){ el.addEventListener('click',handler); el.classList.add('btn-enviar'); }
  });
}
wireEnviarButtons();

/* ===== HIST√ìRICO ===== */
function readHistoryFromKey(k){
  const arr = lsGet(k,[]);
  const m = k.match(/^cotacao:([^:]*):([^:]*):([^:]*):history$/);
  const meta = m ? {empresa:m[1], fornecedor:m[2], painel:m[3]} : {};
  return arr.map(r=>({
    ts:r.ts, enviados:r.enviados,
    fornecedor:r.fornecedor||meta.fornecedor||'',
    empresa:r.empresa||meta.empresa||'',
    painel:r.painel||meta.painel||''
  }));
}
function getAllHistory(onlyCurrent=true){
  if(onlyCurrent){ return readHistoryFromKey(keyBase+":history"); }
  let out=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k && k.startsWith('cotacao:') && k.endsWith(':history')) out=out.concat(readHistoryFromKey(k));
  }
  return out.sort((a,b)=>b.ts-a.ts);
}
function renderHistory(){
  const onlyCurrent = $('histOnlyCurrent').checked;
  const body = $('histBody');
  const empty = $('histEmpty');
  body.innerHTML='';
  const rows = getAllHistory(onlyCurrent);
  $('histCount').textContent = rows.length ? `${rows.length} registro(s)` : '';
  if(!rows.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${fmtData(r.ts)}</td><td>${r.fornecedor||''}</td><td>${r.empresa||''}</td><td>${r.painel||''}</td><td>${r.enviados||0}</td>`;
    body.appendChild(tr);
  });
}
switchTab('cotacao');
</script>
</body>
</html>
