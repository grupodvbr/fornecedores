<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Responder Cota√ß√£o</title>
<style>
  body{font-family:Inter,Arial,sans-serif;background:#f9fafb;margin:0;padding:20px}
  .box{max-width:920px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  h1{text-align:center;margin:0 0 10px}
  p#info{margin:6px 0 14px;color:#6b7280}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e7eb;padding:8px}
  th{background:#2563eb;color:#fff}
  input,button{padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:15px}
  input[type=text].money{width:120px;text-align:right}
  input[type=text]{width:100%}
  button[type=submit]{width:100%;margin-top:16px;background:#2563eb;color:#fff;cursor:pointer}
  button[type=submit]:hover{background:#1d4ed8}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:999}
  .overlay .card{background:#fff;padding:18px 22px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.25);font-weight:600}
</style>
</head>
<body>
  <div class="box">
    <h1 id="titulo">Responder Cota√ß√£o</h1>
    <p id="info">Carregando cota√ß√µes pendentes‚Ä¶</p>

    <form id="formRespostas">
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Qtd</th>
            <th>Unid</th>
            <th>Pre√ßo Unit.</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <button type="submit">üì§ Enviar Respostas</button>
    </form>
  </div>

  <div class="overlay" id="overlay"><div class="card">‚è≥ Salvando na planilha‚Ä¶</div></div>

<script>
const URL_COTACAO = "https://script.google.com/macros/s/AKfycbzRQ0GAmz9m_2F-Ms4DzLQWUqQvmlpBxeMpVOPoXvvuRx-VkjqZbSIVGSWTo2-okjvD/exec"; // üëà TROQUE AQUI

let fornecedor="", empresa="";
let itens=[];

window.addEventListener('load', async ()=>{
  const p = new URLSearchParams(location.search);
  fornecedor = p.get("fornecedor") || "FORNECEDOR";
  empresa    = p.get("empresa")    || "";
  document.getElementById('titulo').textContent = `Responder Cota√ß√£o ‚Äì ${fornecedor}`;
  await carregarItens();
});

function normalizeMoneyInputString(v){
  if(!v) return "";
  return String(v).replace(/\s/g,'').replace(',','.');
}

async function carregarItens(){
  try{
    const res = await fetch(`${URL_COTACAO}?action=listar_fornecedores&empresa=${encodeURIComponent(empresa)}`);
    const out = await res.json();
    if(!out.ok || !out.items || out.items.length===0){
      document.getElementById('info').textContent = "‚úÖ Nenhuma cota√ß√£o pendente.";
      return;
    }
    itens = out.items;
    render();
    document.getElementById('info').textContent = `Exibindo ${itens.length} cota√ß√µes pendentes`;
  }catch(e){
    alert("Erro ao carregar itens: " + e.message);
  }
}

function render(){
  const tb = document.getElementById('tbody');
  tb.innerHTML = "";
  itens.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.produto}</td>
      <td>${it.quantidade ?? ''}</td>
      <td>${it.unidade ?? ''}</td>
      <td>
        <input type="text" class="money" inputmode="decimal" placeholder="0,00"
               data-rid="${it.rid}" data-codigo="${it.codigo || ''}" data-produto="${it.produto}">
      </td>
      <td><input type="text" class="obs" placeholder="Observa√ß√£o"></td>
    `;
    tb.appendChild(tr);
  });

  // m√°scara b√°sica: somente d√≠gitos, v√≠rgula e ponto
  document.querySelectorAll('input.money').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      let v = inp.value.replace(/[^\d.,]/g,'');
      // n√£o deixa mais de um separador decimal
      const parts = v.split(/[.,]/);
      if(parts.length>1){
        v = parts.shift() + ',' + parts.join('');
      }
      inp.value = v;
    });
  });
}

function showOverlay(on){ document.getElementById('overlay').style.display = on ? 'flex' : 'none'; }

document.getElementById('formRespostas').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const linhas = document.querySelectorAll('#tbody tr');
  if(!linhas.length){ alert('Nada para enviar.'); return; }

  showOverlay(true);
  let enviados = 0, erros = [];

  for(const ln of linhas){
    const inputPreco = ln.querySelector('input.money');
    const precoStr   = normalizeMoneyInputString(inputPreco.value);
    const obs        = ln.querySelector('input.obs').value || "";

    // envia somente linhas com pre√ßo preenchido (>= 0,00 conta tamb√©m)
    if(precoStr === "") continue;

    const payload = {
      action: "responder_fornecedor",
      rid: inputPreco.dataset.rid,
      produtoCodigo: inputPreco.dataset.codigo,
      produtoNome: inputPreco.dataset.produto,
      fornecedor,
      preco: precoStr,           // GAS normaliza v√≠rgula/ponto
      observacoes: obs,
      empresa
    };

    try{
      const res = await fetch(URL_COTACAO, {
        method: "POST",
        headers: {"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify(payload)
      });
      const out = await res.json();
      if(out.ok){ enviados += (out.count || 1); }
      else{ erros.push(out.error || 'Falha desconhecida'); }
    }catch(err){
      erros.push(String(err));
    }
  }

  showOverlay(false);

  if(erros.length){
    alert(`‚ö†Ô∏è Enviadas: ${enviados}\nErros: ${erros.length}\n\nPrimeiro erro: ${erros[0]}`);
  }else{
    alert(`‚úÖ ${enviados} respostas registradas para ${fornecedor}`);
  }
});
</script>
</body>
</html>
