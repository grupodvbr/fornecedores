<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Responder Cota√ß√£o</title>
  <style>
    :root{
      --bg:#f9fafb; --card:#fff; --txt:#111827; --muted:#6b7280;
      --brand:#2563eb; --brand-2:#1d4ed8; --ok:#065f46; --okbg:#ecfdf5; --warn:#9a3412; --warnbg:#fff7ed; --bd:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--txt);margin:0;padding:20px}
    .box{max-width:980px;margin:auto;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    h1{margin:0 0 8px;text-align:center}
    p#info{margin:4px 0 12px;color:var(--muted);text-align:center}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin:8px 0 10px}
    .toolbar select,.toolbar input{padding:10px 12px;border:1px solid var(--bd);border-radius:8px;font-size:15px}
    .toolbar .hint{font-size:12px;color:var(--muted);width:100%;text-align:center}
    .badge{display:inline-flex;align-items:center;gap:8px;background:var(--okbg);border:1px solid #6ee7b7;color:var(--ok);padding:8px 10px;border-radius:999px;font-size:14px;margin:6px auto 12px;justify-content:center}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--bd);padding:10px}
    th{background:var(--brand);color:#fff}
    input,button{padding:10px;border:1px solid var(--bd);border-radius:8px;font-size:15px}
    input.money{width:130px;text-align:right}
    input[type=text]{width:100%}
    button[type=submit]{width:100%;margin-top:16px;background:var(--brand);border:none;color:#fff;cursor:pointer}
    button[type=submit]:hover{background:var(--brand-2)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:999}
    .overlay .card{background:#fff;padding:18px 22px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.25);font-weight:600}
    .notice{background:var(--warnbg);border:1px solid #fdba74;color:var(--warn);padding:12px;border-radius:10px;margin:10px 0}
    .success{background:var(--okbg);border:1px solid #6ee7b7;color:var(--ok);padding:12px;border-radius:10px;margin:10px 0}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .btn-secondary{background:#eef2ff;border:1px solid #c7d2fe;color:#1e3a8a;cursor:pointer}
    .btn-secondary:hover{filter:brightness(.98)}
    .inline-tip{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
  </style>
</head>
<body>
  <div class="box">
    <h1 id="titulo">Responder Cota√ß√£o</h1>
    <p id="info">Fa√ßa login para visualizar os itens.</p>

    <!-- Toolbar -->
    <div class="toolbar">
      <label>Fornecedor:
        <select id="selFornecedor"></select>
      </label>
      <label>Senha:
        <input id="inputSenha" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="Digite a senha">
      </label>
      <button id="btnValidar" class="btn-secondary" type="button">Validar fornecedor</button>
      <span class="hint">Os itens s√≥ aparecem ap√≥s o login e permanecem at√© o fim da janela.</span>
    </div>

    <!-- ‚ÄúEmpresa logada‚Äù depois de validar -->
    <div id="badgeLogin" class="badge" style="display:none">‚úÖ Logado</div>

    <div id="statusEnvio" class="success" style="display:none"></div>
    <div id="avisoExpirado" class="notice" style="display:none"></div>

    <form id="formRespostas">
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Qtd</th>
            <th>Unid</th>
            <th>Pre√ßo Unit.</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="inline-tip" id="dicaMascara" style="display:none">Dica: no celular, digite apenas n√∫meros. Ex.: ‚Äú1234‚Äù vira ‚Äú12,34‚Äù.</div>
      <button id="btnEnviar" type="submit" style="display:none">üì§ Enviar Respostas</button>
      <div class="actions">
        <button id="btnSolicitarLiberacao" type="button" class="btn-secondary" style="display:none">Solicitar libera√ß√£o</button>
      </div>
      <p id="timer" class="muted" style="text-align:center;margin-top:8px;display:none"></p>
    </form>
  </div>

  <div class="overlay" id="overlay"><div class="card">‚è≥ Salvando na planilha‚Ä¶</div></div>

<script>
/* ===================== CONFIG ===================== */
const URL_COTACAO = "https://script.google.com/macros/s/AKfycbyq0tGr8djdAoO3i_PfYPdPAWHknqL_hsIiVV28A_YgmpBivbpsbbp3x3E4Vo0M-zqx/exec";
const VALIDADE_MS = 60 * 60 * 1000; // 1h

/* ============== Estado =============== */
let fornecedor = "", empresa = "", painel = "";
let itens = [];
let keyBase = "";
let abriuEm = null;
let timerId = null;

/* ============== Utils =============== */
const lsGet = (k, def=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def }catch{ return def } };
const lsSet = (k, v)=>localStorage.setItem(k, JSON.stringify(v));
const lsDel = (k)=>localStorage.removeItem(k);
const showOverlay = (on)=>{ document.getElementById('overlay').style.display = on ? 'flex' : 'none'; };
const disableForm = (on)=>{ document.querySelectorAll('#formRespostas input, #formRespostas button[type=submit]').forEach(el=>el.disabled=on); };
const fmtData = (dt)=>{ try{ return new Date(dt).toLocaleString('pt-BR'); }catch{ return String(dt); } };
const showElems = (on, ...ids)=>ids.forEach(id=>document.getElementById(id).style.display = on ? '' : 'none');

/* ====== M√°scara: s√≥ n√∫meros ‚Üí ‚Äú12,34‚Äù ====== */
function centsToBR(vCents){
  const neg = vCents < 0;
  vCents = Math.abs(vCents);
  const s = vCents.toString().padStart(3,'0');
  const i = s.slice(0, -2) || '0';
  const d = s.slice(-2);
  const iFmt = i.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  return (neg?'-':'') + iFmt + ',' + d;
}
function moneyBindInputs(){
  document.querySelectorAll('input.money').forEach(inp=>{
    inp.type = "text";
    inp.inputMode = "decimal";
    inp.autocomplete = "off";
    inp.spellcheck = false;

    inp.dataset.cents = inp.dataset.cents || "0";
    inp.value = centsToBR(parseInt(inp.dataset.cents,10)||0);

    inp.addEventListener('input', ()=>{
      const digits = (inp.value.replace(/\D/g,'') || "0").replace(/^0+(?=\d)/,'');
      const cents = parseInt(digits,10) || 0;
      inp.dataset.cents = String(cents);
      inp.value = centsToBR(cents);
    });
    inp.addEventListener('focus', ()=>{ setTimeout(()=>inp.select(), 0); });
  });
}
function centsToDotDecimal(cents){
  const v = (parseInt(cents,10)||0)/100;
  return v.toFixed(2);
}

/* ====== Sess√£o / janela ====== */
function setOpenTimeIfMissing(){
  const k = keyBase + ":openTs";
  let ts = lsGet(k, null);
  if(!ts){ ts = Date.now(); lsSet(k, ts); }
  abriuEm = ts;
}
function isExpiredLocal(){ return abriuEm ? (Date.now() - abriuEm) > VALIDADE_MS : false; }
function isLogged(){ return !!lsGet(keyBase + ":logged", null) && !isExpiredLocal(); }

function renderCountdown(){
  const el = document.getElementById('timer');
  if(!abriuEm){ el.style.display='none'; return; }
  const left = VALIDADE_MS - (Date.now() - abriuEm);
  if(left <= 0){ el.textContent = "‚õî Cota√ß√£o expirada."; return; }
  const m = Math.floor(left/60000), s = Math.floor((left%60000)/1000);
  el.textContent = `‚è±Ô∏è Tempo restante (1¬™ janela): ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  el.style.display = 'block';
}
function startCountdown(){
  if(timerId) clearInterval(timerId);
  renderCountdown();
  timerId = setInterval(()=>{
    renderCountdown();
    if(isExpiredLocal()){
      onExpiredUI(); // encerra sess√£o e oculta itens
      clearInterval(timerId);
    }
  }, 1000);
}

/* ====== Libera√ß√£o servidor ====== */
async function checkServerLiberation(){
  try{
    const url = `${URL_COTACAO}?action=checar_liberacao&empresa=${encodeURIComponent(empresa)}&fornecedor=${encodeURIComponent(fornecedor)}&painel=${encodeURIComponent(painel)}`;
    const r = await fetch(url);
    const j = await r.json();
    return !!(j && j.ok && j.liberado);
  }catch{ return false; }
}

/* ====== Hist√≥rico / bloqueio duplicado ====== */
function blockIfAlreadySent(){
  const sent = lsGet(keyBase + ":sent", null);
  if(sent && sent.fornecedor === fornecedor){
    const info = document.getElementById('statusEnvio');
    info.style.display = 'block';
    info.innerHTML = `‚úÖ Respostas j√° enviadas por <b>${sent.fornecedor}</b> em <b>${fmtData(sent.ts)}</b>. Envio duplicado n√£o √© permitido.`;
    disableForm(true);
    return true;
  }
  return false;
}
function pushHistory(enviados){
  const k = keyBase + ":history";
  const arr = lsGet(k, []);
  arr.push({ ts: Date.now(), enviados, fornecedor });
  lsSet(k, arr);
}

/* ====== UI: entrar/sair logado ====== */
function lockLoginControls(on){
  document.getElementById('selFornecedor').disabled = on;
  document.getElementById('inputSenha').disabled = on;
  document.getElementById('btnValidar').disabled = on;
  if(on){
    document.getElementById('selFornecedor').title = "Bloqueado at√© acabar a janela";
    document.getElementById('inputSenha').title = "Bloqueado at√© acabar a janela";
    document.getElementById('btnValidar').title = "Bloqueado at√© acabar a janela";
  }else{
    document.getElementById('selFornecedor').removeAttribute('title');
    document.getElementById('inputSenha').removeAttribute('title');
    document.getElementById('btnValidar').removeAttribute('title');
  }
}
async function enterLoggedState(){
  // inicia janela e exibe itens
  setOpenTimeIfMissing();
  startCountdown();
  lockLoginControls(true);
  const badge = document.getElementById('badgeLogin');
  badge.textContent = `‚úÖ Logado como ${fornecedor} | Empresa: ${empresa || '‚Äî'}`;
  badge.style.display = 'inline-flex';

  // mostra elementos da grade/salvar
  showElems(true, 'btnEnviar', 'dicaMascara');

  // carrega itens s√≥ agora
  await carregarItens();

  // se j√° enviou, travamos inputs (mas a lista permanece vis√≠vel)
  blockIfAlreadySent();

  document.getElementById('info').textContent = `Itens liberados durante a janela.`;
}
function onExpiredUI(){
  // fim da janela: derruba sess√£o e oculta itens
  lsDel(keyBase + ":logged");
  const box = document.getElementById('avisoExpirado');
  box.style.display = 'block';
  box.innerHTML = "‚õî A janela expirou. Solicite libera√ß√£o no painel de cota√ß√µes.";
  disableForm(true);
  document.getElementById('btnSolicitarLiberacao').style.display = 'inline-block';
  document.getElementById('timer').style.display = 'block';

  // oculta itens e bot√£o de envio
  document.getElementById('tbody').innerHTML = '';
  showElems(false, 'btnEnviar', 'dicaMascara');

  // reabilita login para uma nova janela/libera√ß√£o
  lockLoginControls(false);
  document.getElementById('badgeLogin').style.display = 'none';
  document.getElementById('info').textContent = "Fa√ßa login para visualizar os itens.";
}

/* =================== Carregamento =================== */
window.addEventListener('load', async ()=>{
  const p = new URLSearchParams(location.search);
  empresa = p.get("empresa") || "";
  painel  = p.get("painel")  || "";
  const fornecedorUrl = p.get("fornecedor") || "";

  fornecedor = fornecedorUrl || "";
  keyBase = `cotacao:${empresa}:${fornecedor}:${painel}`;

  await carregarListaFornecedores(fornecedorUrl);
  document.getElementById('titulo').textContent = `Responder Cota√ß√£o ‚Äì ${fornecedor || '(selecione)'}`;

  // se havia sess√£o v√°lida, volta logado (e s√≥ sai quando esgotar)
  const openTs = lsGet(keyBase + ":openTs", null);
  if(openTs){ abriuEm = openTs; }
  if(isLogged()){
    await enterLoggedState();
  }else{
    // garante que, sem login, nada apare√ßa
    document.getElementById('tbody').innerHTML = '';
    showElems(false, 'btnEnviar', 'dicaMascara');
  }
});

async function carregarListaFornecedores(pref){
  try{
    const r = await fetch(`${URL_COTACAO}?action=fornecedores_lista`);
    const j = await r.json();
    const sel = document.getElementById('selFornecedor');
    sel.innerHTML = '';

    const itens = (j && j.ok && Array.isArray(j.items)) ? j.items : [];
    if(!itens.length){
      sel.innerHTML = '<option value="">(Sem fornecedores cadastrados)</option>';
      fornecedor = "";
      return;
    }
    itens.sort((a,b)=>a.fornecedor.localeCompare(b.fornecedor,'pt-BR'));
    itens.forEach(x=>{
      const op = document.createElement('option');
      op.value = x.fornecedor;
      op.textContent = x.fornecedor;
      sel.appendChild(op);
    });

    if(pref && itens.some(x=>x.fornecedor === pref)){
      sel.value = pref;
      fornecedor = pref;
    }else{
      fornecedor = sel.value;
    }

    keyBase = `cotacao:${empresa}:${fornecedor}:${painel}`;
    sel.addEventListener('change', ()=>{
      fornecedor = sel.value;
      keyBase = `cotacao:${empresa}:${fornecedor}:${painel}`;
      document.getElementById('titulo').textContent = `Responder Cota√ß√£o ‚Äì ${fornecedor}`;
      document.getElementById('statusEnvio').style.display = 'none';
      document.getElementById('badgeLogin').style.display = 'none';
      // troca de fornecedor sem login ‚Üí mant√©m itens ocultos
      document.getElementById('tbody').innerHTML = '';
      showElems(false, 'btnEnviar', 'dicaMascara');
    });
  }catch(e){
    alert("Erro ao carregar fornecedores: "+e.message);
  }
}

async function carregarItens(){
  // seguran√ßa extra: s√≥ carrega se logado
  if(!isLogged()) return;
  try{
    const res = await fetch(`${URL_COTACAO}?action=listar_fornecedores&empresa=${encodeURIComponent(empresa)}`);
    const out = await res.json();
    if(!out.ok || !out.items || out.items.length===0){
      document.getElementById('info').textContent = "‚úÖ Nenhuma cota√ß√£o pendente.";
      document.getElementById('tbody').innerHTML = '';
      return;
    }
    itens = out.items;
    renderTabela();
    document.getElementById('info').textContent = `Exibindo ${itens.length} itens para cota√ß√£o`;
  }catch(e){
    alert("Erro ao carregar itens: " + e.message);
  }
}

function renderTabela(){
  const tb = document.getElementById('tbody');
  tb.innerHTML = "";
  itens.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.produto}</td>
      <td>${it.quantidade ?? ''}</td>
      <td>${it.unidade ?? ''}</td>
      <td>
        <input class="money" placeholder="0,00"
               inputmode="decimal" autocomplete="off"
               data-rid="${it.rid}" data-codigo="${it.codigo || ''}" data-produto="${it.produto}">
      </td>
      <td><input type="text" class="obs" placeholder="Observa√ß√£o" autocomplete="off"></td>
    `;
    tb.appendChild(tr);
  });
  moneyBindInputs();
}

/* ============ Login (valida√ß√£o no GAS) ============ */
async function validarFornecedor(){
  const senha = (document.getElementById('inputSenha').value || '').trim();
  if(!fornecedor){ alert("Selecione o fornecedor."); return false; }
  if(!senha){ alert("Informe a senha do fornecedor."); return false; }
  try{
    const res = await fetch(URL_COTACAO, {
      method: "POST",
      headers: {"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify({ action:"validar_fornecedor", fornecedor, senha })
    });
    const out = await res.json();
    if(out && out.ok){
      // marca sess√£o logada, inicia janela e mostra itens
      lsSet(keyBase + ":logged", { ts: Date.now(), fornecedor });
      await enterLoggedState();
      return true;
    }
    alert("Senha inv√°lida para o fornecedor selecionado.");
    return false;
  }catch(e){
    alert("Falha ao validar fornecedor: "+e.message);
    return false;
  }
}
document.getElementById('btnValidar').addEventListener('click', ()=>{ validarFornecedor(); });
document.getElementById('inputSenha').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); validarFornecedor(); }
});

/* =================== Solicitar libera√ß√£o =================== */
document.getElementById('btnSolicitarLiberacao').addEventListener('click', async ()=>{
  if(!fornecedor){ alert("Selecione o fornecedor."); return; }
  try{
    const res = await fetch(URL_COTACAO, {
      method: "POST",
      headers: {"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify({ action:"solicitar_liberacao", empresa, fornecedor, painel })
    });
    const out = await res.json();
    if(out && out.ok) alert("üì® Solicita√ß√£o de libera√ß√£o enviada. Aguarde aprova√ß√£o no painel.");
    else alert("N√£o foi poss√≠vel solicitar libera√ß√£o.");
  }catch(e){
    alert("Erro ao solicitar libera√ß√£o: "+e.message);
  }
});

/* =================== Envio das respostas =================== */
document.getElementById('formRespostas').addEventListener('submit', async (e)=>{
  e.preventDefault();

  // precisa estar logado e ainda dentro da janela
  if(!isLogged()){ alert("Fa√ßa login novamente para enviar."); return; }
  if(isExpiredLocal()){
    // tenta libera√ß√£o do painel (segundo est√°gio)
    const ok = await checkServerLiberation();
    if(!ok){ onExpiredUI(); return; }
  }

  // bloqueio duplicado
  if(blockIfAlreadySent()) return;

  const linhas = document.querySelectorAll('#tbody tr');
  if(!linhas.length){ alert('Nada para enviar.'); return; }

  showOverlay(true);
  let enviados = 0, erros = [];

  for(const ln of linhas){
    const priceEl = ln.querySelector('input.money');
    const cents   = priceEl.dataset.cents || "0";
    const obs     = ln.querySelector('input.obs').value || "";
    if(parseInt(cents,10) <= 0) continue;

    const payload = {
      action: "responder_fornecedor",
      rid: priceEl.dataset.rid,
      produtoCodigo: priceEl.dataset.codigo,
      produtoNome: priceEl.dataset.produto,
      fornecedor,
      // senha n√£o √© revalidada aqui; login j√° foi feito
      preco: centsToDotDecimal(cents),
      observacoes: obs,
      empresa,
      painelCodigo: painel
    };

    try{
      const res = await fetch(URL_COTACAO, {
        method: "POST",
        headers: {"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify(payload)
      });
      const out = await res.json();
      if(out && out.ok){ enviados += (out.count || 1); }
      else { erros.push(out && out.error ? out.error : 'Falha desconhecida'); }
    }catch(err){
      erros.push(String(err));
    }
  }

  showOverlay(false);

  if(erros.length){
    alert(`‚ö†Ô∏è Enviadas: ${enviados}\nErros: ${erros.length}\n\nPrimeiro erro: ${erros[0]}`);
    return;
  }

  lsSet(keyBase + ":sent", { ts: Date.now(), fornecedor });
  pushHistory(enviados);

  const info = document.getElementById('statusEnvio');
  info.style.display = 'block';
  info.innerHTML = `‚úÖ ${enviados} respostas registradas por <b>${fornecedor}</b> em <b>${fmtData(Date.now())}</b>.`;
  disableForm(true);
});
</script>
</body>
</html>
